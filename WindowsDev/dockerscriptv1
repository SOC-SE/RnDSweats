# Run this script as Administrator

Write-Host "=== Enabling required Windows features for Docker (Hyper-V & Containers) ==="

$restartNeeded = $false

# Enable Hyper-V
$hvResult = Enable-WindowsOptionalFeature -Online -FeatureName Microsoft-Hyper-V -All -NoRestart
if ($hvResult.RestartNeeded) {
    $restartNeeded = $true
}

# Enable Containers
$ctResult = Enable-WindowsOptionalFeature -Online -FeatureName Containers -All -NoRestart
if ($ctResult.RestartNeeded) {
    $restartNeeded = $true
}

if ($restartNeeded) {
    Write-Warning "A system restart is required before Docker can be installed."
    $choice = Read-Host "Do you want to restart now? (Y/N)"
    if ($choice -match '^[Yy]$') {
        Write-Host "Restarting system..."
        Restart-Computer -Force
        exit
    } else {
        Write-Host "Please restart the system manually before running Docker."
    }
}

Write-Host "=== Downloading Docker Desktop Installer... ==="

$DockerInstaller = "$env:TEMP\DockerDesktopInstaller.exe"
Invoke-WebRequest -UseBasicParsing -Uri "https://desktop.docker.com/win/main/amd64/Docker%20Desktop%20Installer.exe" -OutFile $DockerInstaller

Write-Host "=== Installing Docker Desktop ==="
Start-Process -FilePath $DockerInstaller -ArgumentList "install", "--quiet" -Wait -NoNewWindow

Write-Host "=== Configuring Docker Desktop to use Hyper-V backend ==="

# Docker stores settings in a settings.json file under AppData
$DockerConfigPath = "$env:APPDATA\Docker\settings.json"

if (Test-Path $DockerConfigPath) {
    $settings = Get-Content $DockerConfigPath | ConvertFrom-Json
    $settings.wslEngineEnabled = $false   # disable WSL2 backend
    $settings | ConvertTo-Json -Depth 10 | Set-Content $DockerConfigPath -Encoding UTF8
    Write-Host "Docker is configured to use Hyper-V backend."
} else {
    Write-Host "Docker config file not found. Start Docker Desktop once manually, then re-run configuration."
}

Write-Host "=== Installation Complete ==="
Write-Host "Reboot your system if you havenâ€™t already, then launch Docker Desktop."
